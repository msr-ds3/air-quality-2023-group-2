---
title: "Group_2_Work"
author: "Alex H & Elvis"
date: "2023-06-21"
output: pdf_document
---

```{r setup, include=FALSE}
library(here)
library(ggplot2)
library(scales)
library(tidyverse)
library(modelr)

theme_set(theme_bw())
options(repr.plot.width=4, repr.plot.height=3)
knitr::opts_chunk$set(echo = TRUE)
```

## Load Data

```{r load-data}
city_day_agg_cleaned <- read_csv(gzfile('city_day_agg_cleaned.csv.gz'))
country_day_agg_cleaned <- read_csv(gzfile('country_day_agg_cleaned.csv.gz'))
openaq_cities <- read_csv('openaq_cities.csv')
```

## Map

```{r map}
world_map <- map_data("world")

ggplot() +
  geom_polygon(data = world_map,
               aes(x = long, y = lat, group = group),
               fill = "lightgray", color = "white")
```

## Density

Ideas so far (Elvis): Since the map plot requires an x and y in terms of latitude and longitude, and the city dataframe only contains the city's "id", then it seems like a challenge to tie city 821 (for instance), to an actual place on the map (maybe look up how the paper assigned thier ids to the cities, that might tell us which city is which and what their cordiants are). Because of this challenge, I think it will be easier to focus on manpulating the data so we can get a column that contains the percentage change for certain chemicals between (2017-2019) vs 2020 (for months January to May)

```{r Getting change in chemical (2017-2018-2019) vs 2020 (by month)}

#divide city dataframe into two, 2017-2019 and 2020 so you can get the averages for each month and compare them to get the change in the chemical      

before_2020 <- city_day_agg_cleaned %>%
  filter(year(date) < 2020 & month(date) < 6)

after_2020 <- city_day_agg_cleaned %>%
  filter(year(date) >= 2020 & month(date) < 6)

before_2020 <- before_2020 %>%
  group_by(city_id, parameter) %>%
  summarize(agg_mean = mean(mean)) %>%
  mutate(before_2020 = TRUE) %>% 
  ungroup %>% 
  group_by(parameter) %>% 
  mutate(med = median(agg_mean))

after_2020 <- after_2020 %>%
  group_by(city_id, parameter) %>%
  summarize(agg_mean = mean(mean)) %>%
  mutate(before_2020 = FALSE) %>% 
  ungroup %>% 
  group_by(parameter) %>% 
  mutate(med = median(agg_mean))

df <- bind_rows(before_2020, after_2020)

ggplot(df, aes(x = agg_mean, fill = before_2020)) +
  geom_density(alpha = 0.5) +
  geom_vline(data = subset(df, !before_2020), aes(xintercept = median(agg_mean)), color = "red", size = 1) +
  geom_vline(data = subset(df, before_2020), aes(xintercept = median(agg_mean)), color = "blue", size = 1) +
  labs(
    title = "Distribution of Air Pollution",
    x = "Parameter",
    y = "Density"
  ) +
  facet_wrap(~ parameter, scales = "free") +
  scale_fill_manual(values = c("red", "blue"),
                    labels = c("2020", "3-yr avg"),
                    guide = guide_legend(title = "Period"))

median(agg_mean$)



```
